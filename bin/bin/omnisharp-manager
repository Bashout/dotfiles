#!/bin/sh
# OmniSharp-roslyn Management tool
#
# Works on: Linux, macOS & Cygwin/WSL

usage() {
    printf "usage: %s [-irVHu] [-v version] [-l location]\\n" "$0"
}

# From: https://gist.github.com/lukechilds/a83e1d7127b78fef38c2914c4ececc3c
get_latest_version() {
    curl --silent "https://api.github.com/repos/OmniSharp/omnisharp-roslyn/releases/latest" |
    grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/'
}
get_current_version() {
    # TODO implement this
    printf "???"
}


# Options:
# * i :: install (will also update if already installed)
# * r :: remove
# * v :: version to use (otherwise use latest)
# * V :: print the version information
# * l :: where to install the server
# * u :: help / usage info
# * H :: install the HTTP version of the server
# Options to add later:
# * M :: type of server: mono or regular
# * S :: start the server (takes a solution file)

location="$HOME/.omnisharp/"

while getopts irv:Vl:uH o "$@"
do
    case "$o" in
        i)      install;;
        r)      remove;;
        v)      version="$OPTARG";;
        V)
            printf "Latest version:    %s\\n" "$(get_latest_version)"
            printf "Installed version: %s\\n" "$(get_current_version)"
            exit 0
            ;;
        l)      location="$OPTARG";;
        H)      http=".http";;
        u)      usage && exit 0;;
        [?])    usage && exit 1;;
    esac
done

ext="tar.gz"

case "$(uname -s)" in
    "Linux")    os="linux";;
    "Darwin")   os="osx";;
    *)
        if [ "$(uname -o)" = "Cygwin" ]; then
            os="win"
            ext="zip"
            # TODO run post install: chmod +x $(find . -name '*' -type f)
        else
            exit 1
        fi
        ;;
esac
case "$(uname -m)" in
    "x86_64")   machine="x64";;
    "i368")     machine="x86";;
    *)          exit 1;;
esac
file_name=$(printf "omnisharp%s-%s-%s.%s" "$http" "$os" "$machine" "$ext")

if [ -z "$version" ]; then
    version="$(get_latest_version)"
fi
base_url="https://github.com/OmniSharp/omnisharp-roslyn/releases/download"
full_url="${base_url}/${version}/${file_name}"
echo "$full_url"

# TODO Finish this
